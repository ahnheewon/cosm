<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<title>회원가입</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<style type="text/css">
	body {
	background-size: 100%, 100%;
}

.btn-login {
  font-size: 0.9rem;
  letter-spacing: 0.05rem;
  padding: 0.75rem 1rem;
}



.vh-100 gradient-custom {
	margin-top: 300px;
}

	
</style>
</head>

<body style="background-image: url('css/loginBack.png');">
	<section class="vh-100 gradient-custom">
  <div class="container py-5 h-100" >
    <div class="row justify-content-center align-items-center h-100" >
      <div class="col-12 col-md-9 col-md-7" style="width: 60%; margin-left: 100px;">
        <div class="card shadow-2-strong card-registration" style="border-radius: 15px; width: 80%; height: 50%;
            background: hsla(0, 0%, 100%, 0.40);
            backdrop-filter: blur(10px);">
          <div class="card-body p-4 p-md-5">
            <h3 class="mb-4 pb-2 pb-md-0 mb-md-5" style="font-weight: bold; text-align: center">고객 회원가입</h3>
            <form action="clientInsert" method="post" id="empInsertForm">
				<sec:csrfInput/>
				<input type="hidden" th:name="${_csrf.parameterName}"
					th:value="${_csrf.token}" /> <input type="hidden"
					name="usersAuthor" value="고객">

              <div class="row">
                <div class="col-md-6 mb-4">
				  <button id="checkBtn" type="button"
									onclick="checkId()" value="no" style="float: right">중복확인</button>	
                  <div class="form-outline">
                    <label class="form-label" for="firstName">ID</label>
                    <input type="text" id="usersId" name="usersId" class="form-control form-control-sm" />
                  </div>

                </div>
               
              </div>

              <div class="row">
                <div class="col-md-6 mb-4">

                  <div class="form-outline">
                    <label class="form-label" for="lastName">비밀번호</label>
                    <input type="password" id="usersPassword"
								name="usersPassword" class="form-control form-control-sm" />
                  </div>

                </div>
                <div class="col-md-6 mb-4">

                    <div class="form-outline">
                    <label class="form-label" for="lastName">비밀번호 확인</label>
                    <input type="password" id="checkPw"
								 class="form-control form-control-sm" />
								 <label id="chTd" style="width: 300px;"></label>
                  </div>

                  

                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-4 pb-2">

                  <div class="form-outline">
                    <label class="form-label" for="emailAddress">이름</label>
                    <input type="text" id="usersName" name="usersName" class="form-control form-control-sm" />
                  </div>

                </div>
                <div class="col-md-6 mb-4 pb-2">

                  <div class="form-outline">
                    <label class="form-label" for="phoneNumber">대표자명</label>
                    <input type="text" id="manager" name="manager" class="form-control form-control-sm" />
                  </div>

                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-4 pb-2">

                  <div class="form-outline">
                    <label class="form-label" for="emailAddress">거래처명</label>
                    <input type="text" id="clientName" name="clientName" class="form-control form-control-sm" />
                  </div>

                </div>
                <div class="col-md-6 mb-4 pb-2">

                  <div class="form-outline">
                    <label class="form-label" for="phoneNumber">사업자번호</label>
                    <input id="businessNo" name="businessNo"
								required="required" class="form-control form-control-sm" />
                  </div>

                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-4 pb-2">
				  <button id="checkBtn2" type="button" value="no"
									onclick="checkBusinessNo()" style="float: right">진위확인</button>
                  <div class="form-outline">
                    <label class="form-label" for="emailAddress">사업자등록증</label>
                    <input id="licenseImg" name="licenseImg" type="file" class="form-control form-control-sm" />
                  </div>

                </div>
                <div class="col-md-6 mb-4 pb-2">

                  <div class="form-outline">
                    <label class="form-label" for="phoneNumber">등록일자</label>
                    <input type="date" id="openDate" name="openDate" class="form-control form-control-sm" />
                    <input type="hidden" id="changeDate">
                  </div>

                </div>
              </div>

              

              <div class="mt-4 pt-2" align="right">
                <input class="btn btn-primary btn-sm"  onclick="checkForm()" type="submit" value="회원가입"/>
                <input class="btn btn-primary btn-sm"  onclick="location.href='/login'" type="submit" value="취소"/>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
	
	
	
<!-- 	 <div align="center" id="jf">
		<div style="width: 550px; position: relative; top: 50px;">
			<h2>회원가입</h2>
			<form action="clientInsert" method="post" id="empInsertForm">
				<sec:csrfInput/>
				<input type="hidden" th:name="${_csrf.parameterName}"
					th:value="${_csrf.token}" /> <input type="hidden"
					name="usersAuthor" value="고객">
				<table>
					<tbody>
						<tr>
							<th width="200px">아이디</th>
							<td><input type="text" id="usersId" name="usersId"></td>
							<td width="200px"><button id="checkBtn" type="button"
									onclick="checkId()" value="no">중복확인</button></td>
						</tr>
						<tr>
							<th>비밀번호</th>
							<td><input type="password" id="usersPassword"
								name="usersPassword"></td>
						</tr>
						<tr>
							<th>비밀번호 확인</th>
							<td><input type="password" id="checkPw"></td>
							<td id="chTd" style="width: 300px;"></td>
						</tr>
						<tr>
							<th>이름</th>
							<td><input type="text" id="usersName" name="usersName"></td>
						</tr>

						<tr>
							<th>거래처명</th>
							<td><input type="text" id="name" name="name"></td>
						</tr>
						<tr>
							<th>대표자명</th>
							<td><input type="text" id="manager" name="manager"></td>
						</tr>
						<tr>
							<th>사업자번호</th>
							<td><input type="text" id="businessNo" name="businessNo"
								required="required" width="100px"></td>
							<td><button id="checkBtn2" type="button" value="no"
									onclick="checkBusinessNo()">진위확인</button></td>
						</tr>
						<tr>
							<th>사업자등록증</th>
							<td><input id="licenseImg" name="licenseImg" type="file">
								html의 name과 vo의 필드명 다르게 써야함</td>
						</tr>
						<tr>
							<th>등록일자</th>
							<td><input type="date" id="openDate" name="openDate"></td>
							<td><input type="hidden" id="changeDate"></td>
						</tr>
					</tbody>
				</table>
				<hr>
				<button type="button" onclick="checkForm()" class="btn btn-primary">회원추가</button>
				<button type="button" class="btn btn-secondary"
					onclick="location.href='/login'">취소</button>
			</form>
		</div>
	</div> -->

	<script type="text/javascript">
	const header = $("meta[name='_csrf_header']").attr('content');
	const token = $("meta[name='_csrf']").attr('content');
	
		const openDate = "";
		$('#back').click(function () {
			location.href = "/login"
			return false;
		})
		$('#usersId').on('change', function () {
			$('#checkBtn').val("no");
		})
		
		/*-----------------
		사업자번호 체크여부
		- 최종테스트시 not null 걸어서 처음부터 받을지, 마이페이지 수정에서 추가로 받을지 결정 
		function checkBNo() {
			console.log($('#businessNo').val())
			if ($('#businessNo').val() == "" || $('#businessNo').val() == null) {
				alert('사업자번호를 입력해주세요!');
				return false;
			}
			if ($('#checkBtn2').val() != "Yes") {
				alert('사업자번호 진위확인을 해주세요!');
			}
			$('#empInsertForm').submit();
		}
		-----------------*/
		
		/*-----------------
		개업일자 date -> string 20221111
		*-----------------*/
		$('#openDate').change(function(){
			console.log($('#openDate').val());
			let str = $('#openDate').val(); //날짜를 받아와서 
			let strArray = str.split("-") //배열에 담아주고 -을 기준으로 나눠줌
			console.log(strArray);
			
			let result = "";
			for(let el of strArray){
				result = result.concat(el);
			}
			console.log('changeDate',result);
			$('#changeDate').val(result);
		})
		
		$('#checkPw').on('keyup',function(){
			$('#chTd').text('')
			if($('#checkPw').val()!=$('#usersPassword').val()){
				$('#chTd').text('비밀번호가 일치하지 않습니다.').css('color','red');
			}else if($('#checkPw').val()==''){
				$('#chTd').text('비밀번호 확인을 입력하세요.').css('color','red');
			} else{
				$('#chTd').text('비밀번호가 일치합니다').css('color','green');
			}
		})
		$('#usersPassword').on('keyup',function(){
			$('#chTd').text('')
			if($('#checkPw').val()!=$('#usersPassword').val()){
				$('#chTd').text('비밀번호가 일치하지 않습니다.').css('color','red');
			}else if($('#checkPw').val()==''){
				$('#chTd').text('비밀번호 확인을 입력하세요.').css('color','red');
			} else{
				$('#chTd').text('비밀번호가 일치합니다').css('color','green');
			}
		})

		function checkForm() {
			console.log($('#usersId').val())
			if ($('#usersId').val() == "" || $('#usersId').val() == null) {
				Swal.fire(
                        '아이디 중복확인',
                        '아이디를 입력하세요!',
                        'error'
                    )
				return false;
			}
			if ($('#checkBtn').val() != "Yes") {
				Swal.fire(
                        '아이디 중복확인',
                        '아이디 중복확인을 해주세요',
                        'error'
                    )
				return false;
			}
			if($('#checkPw').val()!=$('#usersPassword').val()){
				Swal.fire(
                        '비밀번호 확인',
                        '비밀번호와 비밀번호 확인은 동일해야합니다',
                        'error'
                    )
				return false;
			}
			/*---------------
			 사업자번호 체크 여부
			console.log($('#businessNo').val());
			if ($('#businessNo').val() == "" || $('#businessNo').val() == null) {
				alert('사업자번호를 입력해주세요!');
				return false;
			}
			if ($('#checkBtn2').val() != "Yes" || $('#businessNo').val() == null ) {
				alert('사업자번호 진위확인을 해주세요!');
			}
			 ----------------*/
			$('#empInsertForm').submit();
		}

		function checkId() {
			var usersId = $('#usersId').val();
			console.log(usersId);
			$.ajax({
				url: "/userCheckId",
				type: "get",
				data: {
					usersId: usersId
				},
				async: false,
				beforeSend: function (xhr) {
					xhr.setRequestHeader(header, token);
				},
				success: function (data) {
					if (data == 0 && usersId != "") {
						Swal.fire(
		                        '아이디 중복확인',
		                        '사용 할 수 있는 아이디 입니다',
		                        'success'
		                    )
						$('#checkBtn').val("Yes");

					}else if( usersId==""){
						Swal.fire(
		                        '아이디 중복확인',
		                        '아이디를 입력해주세요'
		                    )
					} else {
						Swal.fire(
		                        '아이디 중복확인',
		                        '이미 존재하는 아이디입니다',
		                        'error'
		                    )
						$('#usersId').val("");
						$('#usersId').focus();
					}
					console.log(data);
				},
				error: function (reject) {
					console.log(reject);
				}
			})
		}

		/*-----------------
		사업자번호 중복체크
		json - 요청방식
		*-----------------*/
		function checkBusinessNo() {
			let ser1 ='TbtTqTFxQYPiIOJLO24eNSOv8Y/jrbuykAjul8JMntvWnmx+r9qgfSpR/8dcaKGk87MRjwmu1O2fqYFl0rEmxA==';
			let service = 'TbtTqTFxQYPiIOJLO24eNSOv8Y%2FjrbuykAjul8JMntvWnmx%2Br9qgfSpR%2F8dcaKGk87MRjwmu1O2fqYFl0rEmxA%3D%3D';
 			let bno = document.getElementById('businessNo').value;
 			let openDate = document.getElementById('changeDate').value;
 			let manager = document.getElementById('manager').value;
 			
		 	var data = {
		 			  "businesses": [
		 				    {
		 				      "b_no": bno,
		 				      "start_dt": openDate,
		 				      "p_nm": manager,
		 				      "p_nm2": "",
		 				      "b_nm": "",
		 				      "corp_no": "",
		 				      "b_sector": "",
		 				      "b_type": ""
		 				    }
		 				  ]
		 				};
 
			$.ajax({
				url: "http://api.odcloud.kr/api/nts-businessman/v1/validate?serviceKey="+service+"&returnType=JSON", // serviceKey 값을 xxxxxx에 입력
				type: "POST",
				data: JSON.stringify(data), // json 을 string으로 변환하여 전송
				dataType: "JSON",
				contentType: "application/json",
				async: false,
				success: function (result) {
					console.log('1',result.data[0].valid);
					console.log('2',result.data);
					/* if(result.data[0].valid == '01' && result.status_code == 'OK'){
						alert("정상 인증되었습니다.")
					} else {
						alert("사업자 번호를 다시 확인해 주세요.")
						$('#businessNo').val('');
						$('#businessNo').focus();
					} */
					console.log('3',result);
					
					
					 if (result.data[0].valid == '01' && result.status_code == 'OK' 
							&&  $('#licenseImg').val() != '' ) {
						Swal.fire(
		                        '사업자번호 진위확인',
		                        '사업자번호가 확인되었습니다',
		                        'success'
		                    )
		               
						$('#checkBtn2').val("Yes");

					}else if( result.valid_msg == '확인할 수 없습니다.'){
						Swal.fire(
		                        '사업자번호 인증불가',
		                        '사업자번호를 다시 입력해주세요'
		                    )
					} else { // ($('#licenseImg').val() != '' && )일단보류
						
					} 
					//console.log(data);
				},
				error: function (result) {
					//console.log('result : ',result);
					//console.log(result.responseText); //responseText의 에러메세지 확인
					 if(result.responseText == "{\"status_code\":\"REQUEST_DATA_MALFORMED\"}\n" ){
							Swal.fire(
			                        '필수항목을 입력해주세요',
			                        '사업자번호, 대표자명, 사업자등록일자, 사업자등록증은 필수입니다!',
			                        'error'
			                    )
						}
				}
			});

		}
	</script>
</body>

</html>